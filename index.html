<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCHOW Admin Dashboard</title>
    
    <!-- Google Fonts - Script font for brand -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           CSS VARIABLES - SOCHOW BRAND COLORS
           ============================================ */
        :root {
            --primary-bg: #000000;
            --card-bg: #1a1a1a;
            --card-hover: #242424;
            --accent-red: #e63946;
            --accent-red-hover: #d62828;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
            --border-dark: #333333;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        /* ============================================
           GLOBAL STYLES & RESET
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Main body with solid black background (SOCHOW brand) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--primary-bg);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }
        
        /* Main container with max-width for larger screens */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ============================================
           HEADER SECTION - WITH LOGO
           ============================================ */
        header {
            background: var(--card-bg);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(230, 57, 70, 0.2);
            margin-bottom: 20px;
            border: 1px solid var(--border-dark);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        /* Logo container - Updated for PNG image */
        .logo-container {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            /* Removed white background - logo has its own circle */
        }
        
        /* Logo image styling */
        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(230, 57, 70, 0.4));
        }
        
        /* Header text container */
        .header-text {
            flex: 1;
        }
        
        header h1 {
            font-family: 'Dancing Script', cursive;
            color: var(--text-primary);
            font-size: 36px;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }
        
        .tagline {
            color: var(--accent-red);
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 3px;
            margin-bottom: 5px;
        }
        
        header p {
            color: var(--text-secondary);
            margin-top: 5px;
            font-size: 14px;
        }
        
        /* ============================================
           DASHBOARD GRID LAYOUT
           Two-column layout on desktop, single column on mobile
           ============================================ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .dashboard-grid > .card {
            width: 100%;
        }
        
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                text-align: center;
            }
        }
        
        /* ============================================
           CARD COMPONENT - DARK THEME
           ============================================ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-dark);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(230, 57, 70, 0.2);
        }
        
        .card h2 {
            color: var(--text-primary);
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-red);
        }
        
        .card h3 {
            color: var(--text-primary);
        }
        
        /* ============================================
           MENU MANAGEMENT SECTION
           ============================================ */
        .menu-upload {
            margin-bottom: 20px;
        }
        
        .menu-upload label {
            color: var(--text-primary);
        }
        
        /* Preview area for uploaded menu image */
        .menu-preview {
            width: 100%;
            max-width: 400px;
            border: 2px dashed var(--border-dark);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            background: var(--primary-bg);
        }
        
        .menu-preview img {
            max-width: 100%;
            border-radius: 8px;
        }
        
        .menu-items-list {
            margin-top: 20px;
        }
        
        /* Individual menu item card */
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--primary-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-dark);
            transition: background 0.2s;
            gap: 12px;
        }
        
        .menu-item-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--border-dark);
            flex-shrink: 0;
        }
        
        .menu-item-thumbnail-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: var(--card-bg);
            border: 2px dashed var(--border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .menu-item-info {
            flex: 1;
        }
        
        .menu-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .menu-item-price {
            color: var(--accent-red);
            font-weight: 700;
        }
        
        /* ============================================
           ORDERS QUEUE SECTION
           ============================================ */
        .orders-queue {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* Custom scrollbar for dark theme */
        .orders-queue::-webkit-scrollbar {
            width: 8px;
        }
        
        .orders-queue::-webkit-scrollbar-track {
            background: var(--primary-bg);
            border-radius: 4px;
        }
        
        .orders-queue::-webkit-scrollbar-thumb {
            background: var(--accent-red);
            border-radius: 4px;
        }
        
        /* Order card with color-coded left border */
        .order-card {
            background: var(--primary-bg);
            border-left: 4px solid var(--accent-red);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border-dark);
            border-left-width: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Admin order styling - gold border */
        .order-card.admin-order {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.05);
        }
        
        /* Status-specific border colors */
        .order-card.pending {
            border-left-color: #ffa500;
        }
        
        .order-card.verified {
            border-left-color: var(--success);
        }
        
        .order-card.denied {
            border-left-color: var(--danger);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* Status badge with color coding */
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Different status badge colors */
        .order-status.pending {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid #ffa500;
        }
        
        .order-status.processing {
            background: rgba(230, 57, 70, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
        
        .order-status.prepared {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .order-status.out-for-delivery {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
            border: 1px solid #007bff;
        }
        
        .order-status.delivered {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .order-items {
            margin: 10px 0;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 6px;
            color: var(--text-secondary);
        }
        
        .order-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-red);
            margin: 10px 0;
        }
        
        /* Action buttons container */
        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        /* ============================================
           BUTTON STYLES - DARK THEME
           ============================================ */
        button, .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--accent-red);
            color: white;
            box-shadow: 0 2px 10px rgba(230, 57, 70, 0.3);
        }
        
        .btn-primary:hover {
            background: var(--accent-red-hover);
            box-shadow: 0 4px 15px rgba(230, 57, 70, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--border-dark);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #555555;
        }
        
        /* ============================================
           FORM ELEMENTS - DARK THEME
           ============================================ */
        input[type="text"],
        input[type="number"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
            background: var(--primary-bg);
            color: var(--text-primary);
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-red);
            box-shadow: 0 0 10px rgba(230, 57, 70, 0.3);
        }
        
        input::placeholder,
        textarea::placeholder {
            color: var(--text-muted);
        }
        
        /* ============================================
           RECEIPT IMAGE DISPLAY
           ============================================ */
        .receipt-image {
            max-width: 200px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            border: 2px solid var(--border-dark);
            transition: transform 0.2s;
        }
        
        .receipt-image:hover {
            opacity: 0.8;
            transform: scale(1.05);
            border-color: var(--accent-red);
        }
        
        /* ============================================
           MODAL COMPONENT
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--accent-red);
        }
        
        .modal-content h2 {
            color: var(--text-primary);
        }
        
        .modal-content img {
            max-width: 100%;
            border-radius: 8px;
        }
        
        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
        }
        
        .close-modal:hover {
            color: var(--accent-red);
        }
        
        /* ============================================
           STATISTICS DASHBOARD
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Stat card with SOCHOW brand colors */
        .stat-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #2a2a2a 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-dark);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(230, 57, 70, 0.4);
            border-color: var(--accent-red);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--accent-red);
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            color: var(--text-secondary);
        }
        
        /* ============================================
           ALERT MESSAGES
           ============================================ */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        /* ============================================
           UTILITY CLASSES
           ============================================ */
        strong {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ============================================
             HEADER SECTION - WITH SOCHOW LOGO
             ============================================ -->
        <header>
            <!-- Logo - Using actual SOCHOW brand image from uploads folder -->
            <div class="logo-container">
                <img src="uploads/sochow-logo.png" alt="SOCHOW Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <!-- Fallback if image fails to load -->
                <div style="display: none; color: var(--accent-red); font-size: 24px;">üé©</div>
            </div>
            
            <div class="header-text">
                <h1>Sochow</h1>
                <div class="tagline">CHEAP BUT RICH</div>
                <p>Admin Dashboard ‚Ä¢ Manage menu, verify payments, track orders</p>
            </div>
        </header>

        <!-- ============================================
             STATISTICS OVERVIEW
             Real-time metrics updated from orders data
             - Pending Payments: Orders awaiting verification
             - Processing: Orders being prepared
             - Today's Orders: All orders placed today
             - Today's Revenue: Sum of verified payments today
             ============================================ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stat-pending">0</div>
                <div class="stat-label">Pending Payments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-processing">0</div>
                <div class="stat-label">Processing</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-today">0</div>
                <div class="stat-label">Today's Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-revenue">‚Ç¶0</div>
                <div class="stat-label">Today's Revenue</div>
            </div>
        </div>

        <!-- ============================================
             MAIN DASHBOARD GRID
             Two-column layout (responsive)
             Left: Menu Management | Right: Orders Queue
             ============================================ -->
        <div class="dashboard-grid">
            <!-- ============================================
                 MENU MANAGEMENT CARD
                 Admin can:
                 1. Upload menu image (shown to customers)
                 2. Add new menu items with name, price, description
                 3. Toggle item availability (show/hide from menu)
                 4. Delete items
                 ============================================ -->
            <div class="card">
                <h2>üë®‚Äçüç≥ Menu Management</h2>
                
                <!-- Menu image upload section -->
                <div class="menu-upload">
                    <label><strong>Upload Menu Image</strong></label>
                    <input type="file" id="menu-image-upload" accept="image/*">
                    <!-- Preview area - shows uploaded image or placeholder -->
                    <div class="menu-preview" id="menu-preview">
                        <p style="color: #999;">No menu image uploaded</p>
                    </div>
                    <button class="btn-primary" onclick="uploadMenuImage()">Save Menu Image</button>
                </div>

                <!-- Menu items CRUD section -->
                <div class="menu-items-section">
                    <h3 style="margin-bottom: 15px;">Menu Items</h3>
                    
                    <!-- Add new item form -->
                    <div style="background: var(--primary-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-dark);">
                        <input type="text" id="item-name" placeholder="Item name (e.g., Burger)">
                        <input type="number" id="item-price" placeholder="Price in Naira (e.g., 2500)">
                        <textarea id="item-description" placeholder="Description (optional)" rows="2"></textarea>
                        <input type="file" id="item-image" accept="image/*" style="margin-top: 8px;">
                        <button class="btn-success" onclick="addMenuItem()">‚ûï Add Item</button>
                    </div>

                    <!-- List of existing menu items (dynamically populated) -->
                    <div class="menu-items-list" id="menu-items-list">
                        <!-- Menu items will be populated here by renderMenuItems() -->
                    </div>
                </div>
            </div>

            <!-- ============================================
                 ORDERS QUEUE CARD
                 Shows verified orders in various stages:
                 - Processing: Order confirmed, being prepared
                 - Prepared: Ready for delivery
                 - Out for Delivery: With rider
                 - Delivered: Completed
                 Admin can update status and cancel orders
                 ============================================ -->
            <div class="card">
                <h2>üì¶ Orders Queue</h2>
                <div class="orders-queue" id="orders-queue">
                    <!-- Orders will be populated here by renderOrders() -->
                    <p style="color: #999; text-align: center;">No orders yet</p>
                </div>
            </div>
        </div>

        <!-- ============================================
             PAYMENT VERIFICATION SECTION (Full Width)
             Shows orders with pending payment verification
             Admin must review receipt and approve/deny/query
             - Approve: Moves order to Processing status
             - Deny: Asks customer to reupload correct receipt
             - Query: Send message to customer for clarification
             ============================================ -->
        <div class="card">
            <h2>üí≥ Payment Verification</h2>
            <div id="payment-verification">
                <!-- Payment verification items will appear here -->
                <p style="color: #999; text-align: center;">No pending payment verifications</p>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODAL FOR VIEWING RECEIPT IMAGES
         Fullscreen overlay to view payment receipts
         Activated by clicking receipt thumbnail
         ============================================ -->
    <div class="modal" id="receipt-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2>Payment Receipt</h2>
            <img id="modal-receipt-image" src="" alt="Receipt">
        </div>
    </div>

    <script>
        /* ============================================
           JAVASCRIPT - ADMIN DASHBOARD LOGIC
           ============================================
           
           DATA FLOW:
           1. Page loads ‚Üí loadMenuItems() + loadOrders()
           2. Orders fetched from API ‚Üí renderOrders() splits into:
              - Active orders (verified) ‚Üí orders-queue
              - Pending payments ‚Üí payment-verification
           3. Admin actions ‚Üí API calls ‚Üí UI update
           
           API ENDPOINTS (to be implemented in bot.js):
           - GET  /api/menu/items - Fetch menu items
           - POST /api/menu/items - Add new item
           - PATCH /api/menu/items/:id - Update item
           - DELETE /api/menu/items/:id - Delete item
           - POST /api/menu/upload - Upload menu image
           - GET  /api/orders - Fetch all orders
           - POST /api/orders/:id/verify - Approve/deny payment
           - POST /api/orders/:id/query - Send message to customer
           - PATCH /api/orders/:id/status - Update order status
           - POST /api/orders/:id/cancel - Cancel order
           
           STATE MANAGEMENT:
           - menuItems: Array of menu item objects
           - orders: Array of order objects
           Both are in-memory and sync with bot.py API
        */
        
        // ======================================================
        // API Configuration
        // ======================================================
        // For LOCAL development: Use http://localhost:3000/api
        // For PRODUCTION (Render.com): Replace with your deployment URL
        // Example: const API_BASE = 'https://sochow-bot.onrender.com/api';
        const API_BASE = 'http://localhost:3000/api';

        // In-memory state (synced with database via API calls)
        let menuItems = [];  // Menu items list
        let orders = [];     // Orders list

        /* ============================================
           INITIALIZATION
           Called when DOM is fully loaded
           ============================================ */
        document.addEventListener('DOMContentLoaded', () => {
            loadMenuItems();      // Fetch menu from API
            loadOrders();         // Fetch orders from API
            setupAutoRefresh();   // Start 30s polling for new orders
        });

        /* ============================================
           MENU IMAGE UPLOAD - PREVIEW
           Shows preview of selected image before upload
           ============================================ */
        document.getElementById('menu-image-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    // Display image preview
                    document.getElementById('menu-preview').innerHTML = 
                        `<img src="${event.target.result}" alt="Menu">`;
                };
                reader.readAsDataURL(file);
            }
        });

        /* ============================================
           UPLOAD MENU IMAGE
           Sends menu image to API for storage
           TODO: Implement multipart/form-data upload to bot.js
           ============================================ */
        async function uploadMenuImage() {
            const fileInput = document.getElementById('menu-image-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image first');
                return;
            }

            // TODO: Replace with actual API call to bot.js
            // Expected endpoint: POST /api/menu/upload
            // Body: FormData with 'menu_image' file
            // const formData = new FormData();
            // formData.append('menu_image', file);
            // await fetch(`${API_BASE}/menu/upload`, { method: 'POST', body: formData });
            
            showAlert('Menu image uploaded successfully!', 'success');
        }

        /* ============================================
           ADD MENU ITEM
           Creates new menu item from form inputs
           Validates name and price, uploads image, then sends to API
           ============================================ */
        async function addMenuItem() {
            const name = document.getElementById('item-name').value.trim();
            const price = parseInt(document.getElementById('item-price').value);
            const description = document.getElementById('item-description').value.trim();
            const imageFile = document.getElementById('item-image').files[0];

            // Validation
            if (!name || !price) {
                alert('Please enter item name and price');
                return;
            }

            let imageUrl = null;
            
            // Upload image if provided
            if (imageFile) {
                const formData = new FormData();
                formData.append('item_image', imageFile);
                
                try {
                    const uploadResponse = await fetch(`${API_BASE}/menu/upload-item`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        imageUrl = uploadData.imageUrl;
                    } else {
                        showAlert('Failed to upload image', 'error');
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    showAlert('Error uploading image', 'error');
                }
            }

            // Construct item object
            const newItem = {
                name,
                price_naira: price,
                description,
                image_url: imageUrl,
                available: true
            };

            // Send to API
            try {
                const response = await fetch(`${API_BASE}/menu/items`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newItem)
                });
                
                if (response.ok) {
                    const createdItem = await response.json();
                    menuItems.push(createdItem);
                    renderMenuItems();
                    
                    // Clear form inputs
                    document.getElementById('item-name').value = '';
                    document.getElementById('item-price').value = '';
                    document.getElementById('item-description').value = '';
                    document.getElementById('item-image').value = '';
                    
                    showAlert('Menu item added!', 'success');
                } else {
                    showAlert('Failed to add item', 'error');
                }
            } catch (error) {
                console.error('Error adding item:', error);
                showAlert('Error adding item', 'error');
            }
        }

        /* ============================================
           DELETE MENU ITEM
           Removes item from menu after confirmation
           ============================================ */
        async function deleteMenuItem(id) {
            if (!confirm('Delete this item?')) return;
            
            // Send to API
            try {
                const response = await fetch(`${API_BASE}/menu/items/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    menuItems = menuItems.filter(item => item.id !== id);
                    renderMenuItems();
                    showAlert('Item deleted', 'success');
                } else {
                    showAlert('Failed to delete item', 'error');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showAlert('Error deleting item', 'error');
            }
        }

        /* ============================================
           TOGGLE ITEM AVAILABILITY
           Shows/hides item from customer menu
           Item remains in database but not displayed
           ============================================ */
        async function toggleAvailability(id) {
            const item = menuItems.find(i => i.id === id);
            const newAvailable = !item.available;
            
            // Send to API
            try {
                const response = await fetch(`${API_BASE}/menu/items/${id}`, { 
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({available: newAvailable})
                });
                
                if (response.ok) {
                    item.available = newAvailable;
                    renderMenuItems();
                } else {
                    showAlert('Failed to update availability', 'error');
                }
            } catch (error) {
                console.error('Error updating:', error);
                showAlert('Error updating availability', 'error');
            }
        }

        /* ============================================
           RENDER MENU ITEMS
           Updates UI with current menu items list
           Shows name, price, description, availability toggle
           ============================================ */
        function renderMenuItems() {
            const container = document.getElementById('menu-items-list');
            
            if (menuItems.length === 0) {
                container.innerHTML = '<p style="color: #999;">No items added yet</p>';
                return;
            }

            // Generate HTML for each menu item with thumbnail
            container.innerHTML = menuItems.map(item => {
                // Determine thumbnail HTML
                const thumbnailHtml = item.image_url 
                    ? `<img src="${item.image_url}" class="menu-item-thumbnail" alt="${item.name}">`
                    : `<div class="menu-item-thumbnail-placeholder">üçΩÔ∏è</div>`;
                
                return `
                <div class="menu-item">
                    ${thumbnailHtml}
                    <div class="menu-item-info">
                        <div class="menu-item-name">${item.name}</div>
                        <div class="menu-item-price">‚Ç¶${item.price_naira.toLocaleString()}</div>
                        ${item.description ? `<div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-warning" onclick="toggleAvailability(${item.id})">
                            ${item.available ? '‚úì Available' : '‚úó Unavailable'}
                        </button>
                        <button class="btn-danger" onclick="deleteMenuItem(${item.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        /* ============================================
           LOAD ORDERS FROM API
           Fetches all orders and renders them in UI
           Splits orders into:
           - Pending payments ‚Üí payment verification section
           - Verified payments ‚Üí orders queue section
           ============================================ */
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/orders`);
                if (response.ok) {
                    const newOrders = await response.json();
                    
                    // Check for new orders (for notifications)
                    if (orders.length > 0 && newOrders.length > orders.length) {
                        const newOrderCount = newOrders.length - orders.length;
                        showNotification(`${newOrderCount} new order${newOrderCount > 1 ? 's' : ''}!`);
                        playNotificationSound();
                    }
                    
                    orders = newOrders;
                } else {
                    console.error('Failed to load orders');
                    orders = [];
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                orders = [];
            }
            
            renderOrders();   // Update UI
            updateStats();    // Update dashboard stats
        }

        /* ============================================
           RENDER ORDERS
           Splits orders into two sections:
           1. Payment Verification: pending payment status
           2. Orders Queue: verified payment, active orders
           ============================================ */
        function renderOrders() {
            const container = document.getElementById('orders-queue');
            const verificationContainer = document.getElementById('payment-verification');
            
            // Handle empty state
            if (orders.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No orders yet</p>';
                verificationContainer.innerHTML = '<p style="color: #999; text-align: center;">No pending payment verifications</p>';
                return;
            }

            // ORDERS QUEUE: Show verified orders only
            const activeOrders = orders.filter(o => o.payment_status === 'verified');
            container.innerHTML = activeOrders.length === 0 
                ? '<p style="color: #999; text-align: center;">No active orders</p>'
                : activeOrders.map(order => renderOrderCard(order)).join('');

            // PAYMENT VERIFICATION: Show pending payments only
            const pendingPayments = orders.filter(o => o.payment_status === 'pending');
            verificationContainer.innerHTML = pendingPayments.length === 0
                ? '<p style="color: #999; text-align: center;">No pending payment verifications</p>'
                : pendingPayments.map(order => renderPaymentCard(order)).join('');
        }

        /* ============================================
           RENDER ORDER CARD
           Generates HTML for a single order in the queue
           Shows status-specific action buttons:
           - Processing ‚Üí Mark as Prepared
           - Prepared ‚Üí Out for Delivery
           - Out for Delivery ‚Üí Mark as Delivered
           ============================================ */
        function renderOrderCard(order) {
            const statusClass = order.order_status.replace(/\s+/g, '-').toLowerCase();
            const isAdminOrder = order.customer && order.customer.telegram_id === '8560918438';
            return `
                <div class="order-card ${statusClass} ${isAdminOrder ? 'admin-order' : ''}">
                    <div class="order-header">
                        <span class="order-id">${order.order_id} ${isAdminOrder ? 'üîë' : ''}</span>
                        <span class="order-status ${statusClass}">${order.order_status}</span>
                    </div>
                    <div><strong>Customer:</strong> ${order.customer.name} ${isAdminOrder ? '(ADMIN)' : `(${order.customer.telegram_id})`}</div>
                    <div class="order-items">
                        ${order.items.map(i => `${i.name} x${i.qty}`).join(', ')}
                    </div>
                    <div class="order-total">Total: ‚Ç¶${order.total_naira.toLocaleString()}</div>
                    <!-- Status-specific action buttons -->
                    <div class="order-actions">
                        ${order.order_status === 'processing' ? `
                            <button class="btn-success" onclick="updateOrderStatus(${order.id}, 'prepared')">Mark as Prepared</button>
                        ` : ''}
                        ${order.order_status === 'prepared' ? `
                            <button class="btn-primary" onclick="updateOrderStatus(${order.id}, 'out-for-delivery')">Out for Delivery</button>
                        ` : ''}
                        ${order.order_status === 'out-for-delivery' ? `
                            <button class="btn-success" onclick="updateOrderStatus(${order.id}, 'delivered')">Mark as Delivered</button>
                        ` : ''}
                        <button class="btn-danger" onclick="cancelOrder(${order.id})">Cancel Order</button>
                    </div>
                </div>
            `;
        }

        /* ============================================
           RENDER PAYMENT CARD
           Shows order awaiting payment verification
           Displays receipt image and action buttons:
           - Approve: Verify payment and start processing
           - Deny: Reject and ask customer to reupload
           - Query: Send message to customer
           ============================================ */
        function renderPaymentCard(order) {
            return `
                <div class="order-card pending">
                    <div class="order-header">
                        <span class="order-id">${order.order_id}</span>
                        <span class="order-status pending">Pending Payment</span>
                    </div>
                    <div><strong>Customer:</strong> ${order.customer.name}</div>
                    <div class="order-items">
                        ${order.items.map(i => `${i.name} x${i.qty}`).join(', ')}
                    </div>
                    <div class="order-total">Total: ‚Ç¶${order.total_naira.toLocaleString()}</div>
                    <!-- Clickable receipt thumbnail -->
                    ${order.receipt_url ? `
                        <img src="${order.receipt_url}" class="receipt-image" onclick="viewReceipt('${order.receipt_url}')" alt="Receipt">
                    ` : ''}
                    <!-- Payment verification actions -->
                    <div class="order-actions">
                        <button class="btn-success" onclick="verifyPayment(${order.id}, true)">‚úÖ Approve Payment</button>
                        <button class="btn-danger" onclick="verifyPayment(${order.id}, false)">‚ùå Deny Payment</button>
                        <button class="btn-warning" onclick="queryPayment(${order.id})">‚ùì Query Customer</button>
                    </div>
                </div>
            `;
        }

        /* ============================================
           VERIFY PAYMENT
           Admin approves or denies payment receipt
           - Approved: payment_status ‚Üí verified, order_status ‚Üí processing
           - Denied: payment_status ‚Üí denied, bot asks customer to reupload
           ============================================ */
        async function verifyPayment(orderId, approved) {
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/verify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ verified: approved })
                });
                
                if (response.ok) {
                    const order = orders.find(o => o.id === orderId);
                    
                    if (approved) {
                        order.payment_status = 'verified';
                        order.order_status = 'processing';
                        showAlert(`Payment approved for ${order.order_id}`, 'success');
                    } else {
                        order.payment_status = 'denied';
                        showAlert(`Payment denied for ${order.order_id}`, 'danger');
                    }
                    
                    renderOrders();
                    updateStats();
                } else {
                    showAlert('Failed to update payment status', 'error');
                }
            } catch (error) {
                console.error('Error verifying payment:', error);
                showAlert('Error verifying payment', 'error');
            }
        }

        /* ============================================
           QUERY PAYMENT
           Send clarification message to customer
           Used when receipt is unclear or amount mismatches
           ============================================ */
        async function queryPayment(orderId) {
            const order = orders.find(o => o.id === orderId);
            const message = prompt('Enter message to customer:');
            
            if (message) {
                showAlert(`Query sent to ${order.customer.name}`, 'success');
            }
        }

        /* ============================================
           UPDATE ORDER STATUS
           Moves order through workflow stages:
           processing ‚Üí prepared ‚Üí out-for-delivery ‚Üí delivered
           For "out-for-delivery", prompts for rider contact
           ============================================ */
        async function updateOrderStatus(orderId, newStatus) {
            let riderContact = null;
            
            if (newStatus === 'out-for-delivery') {
                riderContact = prompt('Enter rider contact number:');
                if (!riderContact) return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: newStatus, rider_contact: riderContact })
                });
                
                if (response.ok) {
                    const order = orders.find(o => o.id === orderId);
                    order.order_status = newStatus;
                    if (riderContact) order.rider_contact = riderContact;
                    
                    renderOrders();
                    showAlert(`Order ${order.order_id} updated to ${newStatus}`, 'success');
                } else {
                    showAlert('Failed to update order status', 'error');
                }
            } catch (error) {
                console.error('Error updating order:', error);
                showAlert('Error updating order status', 'error');
            }
        }

        /* ============================================
           CANCEL ORDER
           Admin cancels order (with confirmation)
           Bot.js should handle refund logic based on order stage
           ============================================ */
        async function cancelOrder(orderId) {
            if (!confirm('Cancel this order?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/cancel`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const order = orders.find(o => o.id === orderId);
                    order.order_status = 'cancelled';
                    renderOrders();
                    showAlert(`Order ${order.order_id} cancelled`, 'danger');
                } else {
                    showAlert('Failed to cancel order', 'error');
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                showAlert('Error cancelling order', 'error');
            }
        }

        /* ============================================
           VIEW RECEIPT IN MODAL
           Opens fullscreen modal to view receipt image
           ============================================ */
        function viewReceipt(receiptUrl) {
            document.getElementById('modal-receipt-image').src = receiptUrl;
            document.getElementById('receipt-modal').classList.add('active');
        }

        /* ============================================
           CLOSE MODAL
           Hides receipt image modal
           ============================================ */
        function closeModal() {
            document.getElementById('receipt-modal').classList.remove('active');
        }

        /* ============================================
           UPDATE STATS
           Recalculates dashboard statistics from orders data
           - Pending payments count
           - Processing orders count
           - Today's orders count
           - Today's revenue sum (verified only)
           ============================================ */
        function updateStats() {
            const today = new Date().toDateString();
            const todayOrders = orders.filter(o => new Date(o.created_at).toDateString() === today);
            
            // Count pending payments
            document.getElementById('stat-pending').textContent = 
                orders.filter(o => o.payment_status === 'pending').length;
            
            // Count processing orders
            document.getElementById('stat-processing').textContent = 
                orders.filter(o => o.order_status === 'processing').length;
            
            // Count today's orders
            document.getElementById('stat-today').textContent = todayOrders.length;
            
            // Calculate today's revenue (verified payments only)
            const todayRevenue = todayOrders
                .filter(o => o.payment_status === 'verified')
                .reduce((sum, o) => sum + o.total_naira, 0);
            
            document.getElementById('stat-revenue').textContent = 
                `‚Ç¶${todayRevenue.toLocaleString()}`;
        }

        /* ============================================
           LOAD MENU ITEMS
           Fetches menu items from API and renders them
           ============================================ */
        async function loadMenuItems() {
            // Try to fetch from API first
            try {
                const response = await fetch(`${API_BASE}/menu/items`);
                if (response.ok) {
                    menuItems = await response.json();
                    renderMenuItems();
                    return;
                }
            } catch (error) {
                console.log('API not available, using local data');
            }

            // Fallback to hardcoded menu (without image URLs - will be fetched from DB)
            menuItems = [
                {
                    id: 1,
                    name: 'Assorted Pepper Sauce',
                    price_naira: 15000,
                    description: 'Spicy mixed-protein pepper sauce with onions & herbs',
                    available: true
                },
                {
                    id: 2,
                    name: 'Egusi Soup (Family Bowl)',
                    price_naira: 37000,
                    description: 'Rich melon seed soup with assorted meat & vegetables',
                    available: true
                },
                {
                    id: 3,
                    name: 'Okro/Ilasa Soup (Family Bowl)',
                    price_naira: 35000,
                    description: 'Thick okro-based soup with meats & leafy vegetables',
                    available: true
                },
                {
                    id: 4,
                    name: 'Boiled Plantain & Pepper Mix',
                    price_naira: 9500,
                    description: 'Soft ripe plantain with spicy peppered fish/meat',
                    available: true
                },
                {
                    id: 5,
                    name: 'White Rice & Chicken Curry Sauce',
                    price_naira: 9000,
                    description: 'Steamed rice served with aromatic Nigerian curry chicken sauce',
                    available: true
                },
                {
                    id: 6,
                    name: 'Native Palm Oil Jollof (Fisherman Style)',
                    price_naira: 9000,
                    description: 'Palm-oil infused jollof with smoked fish, ponmo & egg',
                    available: true
                },
                {
                    id: 7,
                    name: 'Breakfast Platter',
                    price_naira: 6000,
                    description: 'Scrambled eggs, sausages, croissant, strawberries & grapes',
                    available: true
                },
                {
                    id: 8,
                    name: 'Fresh Fruit Bowl',
                    price_naira: 6000,
                    description: 'Strawberries, blueberries, mango & apples',
                    available: true
                },
                {
                    id: 9,
                    name: 'Beans, Fried Plantain & Peppered Fish',
                    price_naira: 9000,
                    description: 'Nigerian beans porridge served with spicy fish & plantain',
                    available: true
                },
                {
                    id: 10,
                    name: 'White Rice with Fried Plantain & Stew',
                    price_naira: 9000,
                    description: 'Boiled rice with crispy plantain and rich tomato stew',
                    available: true
                }
            ];

            renderMenuItems();
        }

        /* ============================================
           SHOW ALERT
           Displays temporary notification banners and auto-dismisses
           ============================================ */
        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            // Basic positioning for temporary alert
            alert.style.position = 'fixed';
            alert.style.right = '20px';
            alert.style.top = '20px';
            alert.style.zIndex = '9999';
            document.body.appendChild(alert);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alert && alert.parentNode) alert.parentNode.removeChild(alert);
            }, 3000);
        }

        /* ============================================
           AUTO REFRESH / POLLING
           Polls for new orders every 15 seconds
           ============================================ */
        function setupAutoRefresh() {
            setInterval(() => {
                loadOrders();
            }, 15000); // 15 seconds
        }

        /* ============================================
           NOTIFICATION SYSTEM
           Desktop notifications + sound for new orders
           ============================================ */
        function showNotification(message) {
            // Request permission if not already granted
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Show desktop notification if permitted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('SOCHOW Order System', {
                    body: message,
                    icon: '/uploads/sochow-logo.png',
                    badge: '/uploads/sochow-logo.png'
                });
            }
            
            // Also show in-page alert
            showAlert(message, 'success');
        }

        function playNotificationSound() {
            // Create simple notification beep
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Request notification permission on page load
        window.addEventListener('load', () => {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        /* ============================================
           MODAL CLICK OUTSIDE TO CLOSE
           Closes modal when clicking on overlay background
           ============================================ */
        document.getElementById('receipt-modal').addEventListener('click', (e) => {
            if (e.target.id === 'receipt-modal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
